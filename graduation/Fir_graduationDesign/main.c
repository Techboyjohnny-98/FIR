/* autor:Johnny
 * Create Date:2021/4/7
 * Project:FIR_filter_3
 * description:
 *      *设计三个滤波器，分别是20~500Hz（低音），500~2kHz（中音），2k~20kHz（高通）的带通滤波器
 *      *低、中、高音的采样频率分别是5000Hz,20kHz,200kHz
 *      *使用的滤波器窗函数为布莱克曼窗
 */
#include "DSP28x_Project.h"
#include "math.h"

#define FIRNUMBER 51               //滤波器阶数
#define SIGNAL_LOW_FREQ 100.0         //低音频率
#define SIGNAL_MIDDLE_FREQ 1800.0     //中音频率
#define SIGNAL_HIGH_FREQ 10000.0      //高音频率
#define SIGNAL_SAMPLE_FREQ 45000.0    //信号采样频率
#define PI 3.1415926

float InputWave();
float FIR();
float fXn[FIRNUMBER] = {0.0};   //输入数据
float amp_low = 0;      //低音滤波器增益
float amp_middle = 0;   //中音滤波器增益
float amp_high = 1;     //高音滤波器增益
int nIn = 0,nOut = 0;   //对输入输出数据进行计数
float dt = 1.0/SIGNAL_SAMPLE_FREQ;   //采样周期
float t = 0;    //当前时间
float fIn[3000];  //输入信号
float fOut[3000]; //输出信号
int i = 0;

    //低音滤波器 布莱克曼窗
//float fHn_low[FIRNUMBER] = {0,6.18784679968471e-06,2.52773439142918e-05,
//                            5.82139540620012e-05,0.000106157631701917,0.000170484581139467,
//                            0.000252782178951188,0.000354836884992087,0.000478615121928202,
//                            0.000626237262448936,0.000799945022709284,0.00100206271673862,
//                            0.00123495297616486,0.00150096767937403,0.00180239496105732,
//                            0.00214140328412636,0.00251998364863743,0.00293989108444238,
//                            0.00340258662396970,0.00390918097746718,0.00446038113431998,
//                            0.00505644109030651,0.00569711785199127,0.00638163379651785,
//                            0.00710864636899735,0.00787622598211704,0.00868184284560418,
//                            0.00952236329927258,0.0103940560554236,0.0112926085775517,
//                            0.0122131536360481,0.0131503058915213,0.0140982081661758,
//                            0.0150505868771731,0.0160008159267520,0.0169419881756983,
//                            0.0178669934729405,0.0187686020777378,0.0196395521949397,
//                            0.0204726402505554,0.0212608124663725,0.0219972562501160,
//                            0.0226754899026386,0.0232894491563582,0.0238335690995179,
//                            0.0243028601082240,0.0246929765014549,0.0250002767516619,
//                            0.0252218742230440,0.0253556775684916,0.0254004200915744,
//                            0.0253556775684916,0.0252218742230440,0.0250002767516619,
//                            0.0246929765014549,0.0243028601082240,0.0238335690995179,
//                            0.0232894491563582,0.0226754899026386,0.0219972562501160,
//                            0.0212608124663725,0.0204726402505554,0.0196395521949397,
//                            0.0187686020777378,0.0178669934729405,0.0169419881756983,
//                            0.0160008159267520,0.0150505868771731,0.0140982081661758,
//                            0.0131503058915213,0.0122131536360481,0.0112926085775517,
//                            0.0103940560554236,0.00952236329927258,0.00868184284560418,
//                            0.00787622598211704,0.00710864636899735,0.00638163379651785,
//                            0.00569711785199127,0.00505644109030651,0.00446038113431998,
//                            0.00390918097746718,0.00340258662396970,0.00293989108444238,
//                            0.00251998364863743,0.00214140328412636,0.00180239496105732,
//                            0.00150096767937403,0.00123495297616486,0.00100206271673862,
//                            0.000799945022709284,0.000626237262448936,0.000478615121928202,
//                            0.000354836884992087,0.000252782178951188,0.000170484581139467,
//                            0.000106157631701917,5.82139540620012e-05,2.52773439142918e-05,
//                            6.18784679968471e-06,0};
//    //中音滤波器
//float fHn_middle[FIRNUMBER] = {0,1.10926967139049e-06,4.14842440667371e-06,
//                               7.25595248655541e-06,7.14153791135078e-06,-2.07216426288745e-20,
//                               -1.72485144476760e-05,-4.55025458945290e-05,-8.19734234293329e-05,
//                               -0.000118849549471822,-0.000142393601980779,-0.000132753880017875,
//                               -6.47528333422692e-05,9.01487895235882e-05,0.000360628922256975,
//                               0.000771101056389464,0.00133640571897977,0.00205607919357314,
//                               0.00290887289462250,0.00384833739799862,0.00480034329437488,
//                               0.00566336054142646,0.00631214379089507,0.00660517356373532,
//                               0.00639580024865814,0.00554656571307359,0.00394568719804285,
//                               0.00152424170739971,-0.00172774911443532,-0.00574830450561174,
//                               -0.0103954700683307,-0.0154459562018857,-0.0206015750070093,
//                               -0.0255039167674122,-0.0297568679360296,-0.0329556836940160,
//                               -0.0347204888558724,-0.0347313932963179,-0.0327619647015180,
//                               -0.0287076730804202,-0.0226061469573116,-0.0146466606130813,
//                               -0.00516716416507941,0.00536170579017920,0.0163649482585503,
//                               0.0272019237291713,0.0372124542425234,0.0457664329488979,
//                               0.0523126075751550,0.0564221564650622,0.0578230705286886,
//                               0.0564221564650622,0.0523126075751550,0.0457664329488979,
//                               0.0372124542425234,0.0272019237291713,0.0163649482585503,
//                               0.00536170579017920,-0.00516716416507941,-0.0146466606130813,
//                               -0.0226061469573116,-0.0287076730804202,-0.0327619647015180,
//                               -0.0347313932963179,-0.0347204888558724,-0.0329556836940160,
//                               -0.0297568679360296,-0.0255039167674122,-0.0206015750070093,
//                               -0.0154459562018857,-0.0103954700683307,-0.00574830450561174,
//                               -0.00172774911443532,0.00152424170739971,0.00394568719804285,
//                               0.00554656571307359,0.00639580024865814,0.00660517356373532,
//                               0.00631214379089507,0.00566336054142646,0.00480034329437488,
//                               0.00384833739799862,0.00290887289462250,0.00205607919357314,
//                               0.00133640571897977,0.000771101056389464,0.000360628922256975,
//                               9.01487895235882e-05,-6.47528333422692e-05,-0.000132753880017875,
//                               -0.000142393601980779,-0.000118849549471822,-8.19734234293329e-05,
//                               -4.55025458945290e-05,-1.72485144476760e-05,-2.07216426288745e-20,
//                               7.14153791135078e-06,7.25595248655541e-06,4.14842440667371e-06,
//                               1.10926967139049e-06,0};
//    //高音滤波器
//float fHn_high[FIRNUMBER]  = {0,-4.57504307411516e-06,-8.05959790985039e-07,
//                                  -3.03976430492003e-05,-2.60319524348358e-06,-2.70764663163883e-19,
//                                  6.28733633073642e-06,0.000190625579549289,1.59258737141657e-05,
//                                  0.000490180000586487,-3.80110254366999e-05,0.000590130818404468,
//                                  -0.000220530756655125,8.38804334181566e-05,-0.000448504782502352,
//                                  -0.00111389946242853,-0.000388650964017684,-0.00238820790327601,
//                                  0.000375285131995430,-0.00253793496426831,0.00184485053005187,
//                                  -0.000584392052836092,0.00310788910847942,0.00313772933443907,
//                                  0.00247030426677751,0.00653171172494648,-0.00137288648351560,
//                                  0.00668822852996842,-0.00758119979508201,0.00200010015056463,
//                                  -0.0122418478828443,-0.00596582288791496,-0.00978659616002340,
//                                  -0.0125572781246426,0.00307055802149729,-0.0126654088682304,
//                                  0.0228977694860211,-0.00448083363892921,0.0380541679871009,
//                                  0.00834871076870807,0.0326558688185892,0.0182156697015409,
//                                  -0.00480787342791990,0.0182605296762903,-0.0727471039465263,
//                                  0.00726137270504791,-0.153478081519774,-0.00889154558879944,
//                                  -0.219155234959007,-0.0205667030211392,0.755559995662960,
//                                  -0.0205667030211392,-0.219155234959007,-0.00889154558879944,
//                                  -0.153478081519774,0.00726137270504791,-0.0727471039465263,
//                                  0.0182605296762903,-0.00480787342791990,0.0182156697015409,
//                                  0.0326558688185892,0.00834871076870807,0.0380541679871009,
//                                  -0.00448083363892921,0.0228977694860211,-0.0126654088682304,
//                                  0.00307055802149729,-0.0125572781246426,-0.00978659616002340,
//                                  -0.00596582288791496,-0.0122418478828443,0.00200010015056463,
//                                  -0.00758119979508201,0.00668822852996842,-0.00137288648351560,
//                                  0.00653171172494648,0.00247030426677751,0.00313772933443907,
//                                  0.00310788910847942,-0.000584392052836092,0.00184485053005187,
//                                  -0.00253793496426831,0.000375285131995430,-0.00238820790327601,
//                                  -0.000388650964017684,-0.00111389946242853,-0.000448504782502352,
//                                  8.38804334181566e-05,-0.000220530756655125,0.000590130818404468,
//                                  -3.80110254366999e-05,0.000490180000586487,1.59258737141657e-05,
//                                  0.000190625579549289,6.28733633073642e-06,-2.70764663163883e-19,
//                                  -2.60319524348358e-06,-3.03976430492003e-05,-8.05959790985039e-07,
//                                  -4.57504307411516e-06,0};
//低音滤波器 布莱克曼窗
float fHn_low[FIRNUMBER] ={0,6.35753836614680e-05,0.000260387449245185,
                           0.000605610599773531,0.00112161581237028,0.00183624371284657,
                           0.00278040059538717,0.00398513789066797,0.00547841737507434,
                           0.00728179274828003,0.00940725093084357,0.0118544524471621,
                           0.0146085896026421,0.0176390450266035,0.0208989838003997,
                           0.0243259530195587,0.0278434971629851,0.0313637304290979,
                           0.0347907427735765,0.0380246591201596,0.0409661250369475,
                           0.0435209602756258,0.0456047062148008,0.0471467955827736,
                           0.0480940928247141,0.0484135899009650,0.0480940928247141,
                           0.0471467955827736,0.0456047062148008,0.0435209602756258,
                           0.0409661250369475,0.0380246591201596,0.0347907427735765,
                           0.0313637304290979,0.0278434971629851,0.0243259530195587,
                           0.0208989838003997,0.0176390450266035,0.0146085896026421,
                           0.0118544524471621,0.00940725093084357,0.00728179274828003,
                           0.00547841737507434,0.00398513789066797,0.00278040059538717,
                           0.00183624371284657,0.00112161581237028,0.000605610599773531,
                           0.000260387449245185,6.35753836614680e-05,0};

//中音滤波器
float fHn_middle[FIRNUMBER] ={0,2.62507673718510e-05,3.78679175244498e-05,
                              -9.14600371280999e-05,-0.000518718688872788,-0.00142000186521711,
                              -0.00296707550238403,-0.00529080967688430,-0.00843433496063362,
                              -0.0123034152935242,-0.0166253562937008,-0.0209294652656129,
                              -0.0245607061431745,-0.0267334929672684,-0.0266251208291305,
                              -0.0234995115077018,-0.0168436484111054,-0.00649330158623013,
                              0.00727695593083420,0.0237210093024314,0.0416590535379205,
                              0.0595875625720808,0.0758497566608739,0.0888430530340351,
                              0.0972318342855958,0.100131291720504,0.0972318342855958,
                              0.0888430530340351,0.0758497566608739,0.0595875625720808,
                              0.0416590535379205,0.0237210093024314,0.00727695593083420,
                              -0.00649330158623013,-0.0168436484111054,-0.0234995115077018,
                              -0.0266251208291305,-0.0267334929672684,-0.0245607061431745,
                              -0.0209294652656129,-0.0166253562937008,-0.0123034152935242,
                              -0.00843433496063362,-0.00529080967688430,-0.00296707550238403,
                              -0.00142000186521711,-0.000518718688872788,-9.14600371280999e-05,
                              3.78679175244498e-05,2.62507673718510e-05,0};
//高音滤波器
float fHn_high[FIRNUMBER]  = {0,-5.27456865575372e-06,9.59536844320978e-05,
                              -0.000231750994362748,0.000104226185037776,-0.000965661086629212,
                              -0.000661785312803055,-0.00145139744031683,-0.00239812847151537,
                              0.000733143087277754,-0.00368971498084646,0.00797073645695238,
                              -0.00182982869079129,0.0179316795660689,0.00447142531117082,
                              0.0196031787730264,0.0120969437620868,-0.00348898667208083,
                              0.0143117620138948,-0.0608929768600093,0.00642186953686290,
                              -0.141920992264735,-0.00850976087252026,-0.214932418120473,
                              -0.0204671062730046,0.755562846288573,-0.0204671062730046,
                              -0.214932418120473,-0.00850976087252026,-0.141920992264735,
                              0.00642186953686290,-0.0608929768600093,0.0143117620138948,
                              -0.00348898667208083,0.0120969437620868,0.0196031787730264,
                              0.00447142531117082,0.0179316795660689,-0.00182982869079129,
                              0.00797073645695238,-0.00368971498084646,0.000733143087277754,
                              -0.00239812847151537,-0.00145139744031683,-0.000661785312803055,
                              -0.000965661086629212,0.000104226185037776,-0.000231750994362748,
                              9.59536844320978e-05,-5.27456865575372e-06,0};


void main(void){
    nIn = 0; nOut = 0;
    while(1){
        fIn[nIn] = InputWave();
        nIn++;
        fOut[nOut] = FIR();
        nOut++;
        if(nOut == 3000){
            nOut = 0; //在这里设立断点
            nIn = 0;
        }
    }
}

float InputWave(){
    for (i = FIRNUMBER - 1;i > 0; i--){
        fXn[i] = fXn[i - 1];
    }
    t = nOut * dt;
    fXn[0] = sin(2.0*PI*SIGNAL_LOW_FREQ*t)
                + sin(2.0*PI*SIGNAL_MIDDLE_FREQ*t) + sin(2.0*PI*SIGNAL_HIGH_FREQ*t);
    return (fXn[0]);
}

float FIR(){
    float fSum;
    fSum = 0;
    for(i = 0;i<FIRNUMBER;i++){
        fSum+=amp_low*fXn[i]*fHn_low[i] + amp_middle*fXn[i]*fHn_middle[i] + amp_high*fXn[i]*fHn_high[i];
    }
    return (fSum);
}



